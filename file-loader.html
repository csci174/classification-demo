<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teachable Machine Model Uploader</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>

</head>

<body>
    <h1>Upload Your Teachable Machine Model</h1>

    <!-- Input for model.json file -->
    <input type="file" id="model-file" accept=".json">
    <input type="file" id="metadata-file" accept=".json">
    <!-- Input for weight files (they might select multiple files) -->
    <input type="file" id="weights-files" accept=".bin" multiple>

    <!-- Button to trigger model loading -->
    <button id="load-model">Load Model</button>

    <!-- Container for displaying class labels -->
    <div id="class-labels"></div>

    <script>
        // let model;

        // document.getElementById('load-model').addEventListener('click', async () => {
        //     const modelFileInput = document.getElementById('model-file');
        //     const metadataFileInput = document.getElementById('metadata-file');
        //     const weightsFilesInput = document.getElementById('weights-files');

        //     if (modelFileInput.files.length > 0 && weightsFilesInput.files.length > 0 && metadataFileInput.files.length > 0) {

        //         // Get the selected files
        //         const modelFile = modelFileInput.files[0];
        //         const metadataFile = metadataFileInput.files[0];
        //         const weightsFile = Array.from(weightsFilesInput.files[0]);


        //         // Use FileReader to read the content of model.json
        //         const reader = new FileReader();

        //         reader.onload = async (event) => {
        //             try {

        //                 // Load the model using TensorFlow.js
        //                 model = await tmImage.loadFromFiles(modelFile, weightsFile, metadataFile);

        //                 // Retrieve and display class labels
        //                 const classLabels = model.getClassLabels();
        //                 document.getElementById('class-labels').innerHTML = `<p>Class Labels: ${classLabels.join(', ')}</p>`;

        //                 console.log('Model loaded successfully!');
        //             } catch (error) {
        //                 console.error('Failed to load the model:', error);
        //             }
        //         };

        //         // Read the file content as text
        //         reader.readAsText(modelFile);
        //     } else {
        //         alert('Please select all three files (model.json, metadata.json, and weights.bin.');
        //     }
        // });



        // Function to read a file as text
        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();

                reader.onload = (event) => {
                    resolve(event.target.result);
                };

                reader.onerror = (error) => {
                    reject(error);
                };

                reader.readAsText(file);
            });
        }

        // Function to read a file as ArrayBuffer (for binary weight files)
        function readFileAsArrayBuffer(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();

                reader.onload = (event) => {
                    resolve(event.target.result);
                };

                reader.onerror = (error) => {
                    reject(error);
                };

                reader.readAsArrayBuffer(file);  // For binary files
            });
        }

        async function loadModelsFromFileUploader() {
            const modelFileInput = document.getElementById('model-file');
            const metadataFileInput = document.getElementById('metadata-file');
            const weightsFilesInput = document.getElementById('weights-files');

            if (modelFileInput.files.length > 0 && weightsFilesInput.files.length > 0) {
                const modelFile = modelFileInput.files[0];
                const metadataFile = metadataFileInput.files[0];
                const weightsFiles = Array.from(weightsFilesInput.files); // Get the weight files

                try {
                    // Load all files asynchronously with Promise.all
                    const [modelJSONContent, metadataJSONContent, ...weightsContent] = await Promise.all([
                        readFileAsText(modelFile),  // Load model.json as text
                        readFileAsText(metadataFile),
                        ...weightsFiles.map(readFileAsArrayBuffer)  // Load all weight files as ArrayBuffer
                    ]);

                    console.log('Model JSON loaded:', modelJSONContent);
                    console.log('Metadata JSON loaded:', metadataJSONContent);
                    console.log('Weight files loaded:', weightsContent);

                    // Parse the model JSON
                    const parsedModelJSON = JSON.parse(modelJSONContent);
                    console.log('Parsed Model JSON:', parsedModelJSON);

                    const parsedMetadataJSON = JSON.parse(metadataJSONContent);
                    console.log('Parsed Metadata JSON:', parsedMetadataJSON);

                    // Now load the model using tmImage with the loaded files
                    const model = await tmImage.loadFromFiles(modelFile, weightsFiles[0], metadataFile);

                    // Retrieve and display class labels
                    const classLabels = model.getClassLabels();
                    document.getElementById('class-labels').innerHTML = `<p>Class Labels: ${classLabels.join(', ')}</p>`;

                    console.log('Model loaded successfully!');
                } catch (error) {
                    console.error('Failed to load the model:', error);
                }
            } else {
                alert('Please select both the model.json file and the corresponding weight files.');
            }
        }

        // Event listener for loading the model and weights
        document.getElementById('load-model').addEventListener('click', loadModelsFromFileUploader);


    </script>
</body>

</html>